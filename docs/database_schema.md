# PKM Database Schema v2.3 (Observed)

**Observed on:** 2026-02-17 (from `psql` introspection against database `pkm`).

This file is meant to be a **human + agent** reference:
- what exists (schemas/tables)
- how prod vs test works
- what each DB role can do
- column/index/constraint details per table
- operational notes that affect `/db/delete` and `/db/move`

---

## Users

### Roles

| Role | Purpose | Notes |
|---|---|---|
| `pgadmin` | DB owner / superuser | Owns schemas `pkm`, `pkm_test` and all objects. |
| `pkm_ingest` | Application write role | Has broad CRUD on most tables (incl. Tier-1 batch tables), but **does not have DELETE on `pkm.entries`** (prod). Has DELETE on `pkm_test.entries` (test). |
| `pkm_read` | Read-only role | Has `SELECT` on `pkm.entries`, `pkm_test.entries`, and `pkm.runtime_config`. No access to Tier-1 batch tables or idempotency tables (as currently granted). |
| `n8n` | n8n DB role | Has `USAGE` on schema `pkm` and `SELECT` on `pkm.runtime_config` only. No access to entries tables. |

### Database-level access (database `pkm`)

- `pkm` is owned by `pgadmin`.
- `pkm_ingest` and `pkm_read` have **CONNECT** on database `pkm`.
- Database-level ACL also shows `PUBLIC` has TEMP/CONNECT (shown as `=Tc/pgadmin`).

---

## Database

### Extensions

| Extension | Version | Schema | Why it matters |
|---|---:|---|---|
| `pgcrypto` | 1.3 | `public` | Provides `gen_random_uuid()` used as default for `entries.id`. |
| `plpgsql` | 1.0 | `pg_catalog` | Default procedural language. |

### Schemas

| Schema | Owner | Purpose |
|---|---|---|
| `pkm` | `pgadmin` | Production data (default). |
| `pkm_test` | `pgadmin` | Test/experimentation data. |

Schema grants (current):
- `pkm_ingest`: `USAGE` on `pkm`, `pkm_test`
- `pkm_read`: `USAGE` on `pkm`, `pkm_test`
- `n8n`: `USAGE` on `pkm` only

### Tables

#### Inventory (with approximate sizes)

**Production (`pkm`)**
- `entries` (~1232 kB)
- `idempotency_policies` (~16 kB)
- `runtime_config` (~16 kB)
- `t1_batches` (~16 kB)
- `t1_batch_items` (~80 kB)
- `t1_batch_item_results` (~8192 bytes)

**Test (`pkm_test`)**
- `entries` (~488 kB)
- `idempotency_policies` (~16 kB)
- `t1_batches` (~8192 bytes)
- `t1_batch_items` (~8192 bytes)
- `t1_batch_item_results` (~8192 bytes)

### User access per table (current grants)

Legend: `R`=SELECT, `I`=INSERT, `U`=UPDATE, `D`=DELETE

#### Production (`pkm.*`)

| Table | pgadmin | pkm_ingest | pkm_read | n8n |
|---|---|---|---|---|
| `pkm.entries` | RIUD + TRUNCATE/REF/… | **RIU (no D)** | R | — |
| `pkm.runtime_config` | full | RIUD | R | R |
| `pkm.idempotency_policies` | full | RIUD | — | — |
| `pkm.t1_batches` | full | RIUD | — | — |
| `pkm.t1_batch_items` | full | RIUD | — | — |
| `pkm.t1_batch_item_results` | full | RIUD | — | — |

#### Test (`pkm_test.*`)

| Table | pgadmin | pkm_ingest | pkm_read |
|---|---|---|---|
| `pkm_test.entries` | full | RIUD | R |
| `pkm_test.idempotency_policies` | full | RIUD | — |
| `pkm_test.t1_batches` | full | RIUD | — |
| `pkm_test.t1_batch_items` | full | RIUD | — |
| `pkm_test.t1_batch_item_results` | full | RIUD | — |

### Sequences and identity

- `entries.entry_id` is **`GENERATED BY DEFAULT AS IDENTITY`** in both schemas.
- Sequences:
  - `pkm.entries_entry_id_seq`
  - `pkm_test.entries_entry_id_seq`

Current sequence grants:
- `pkm_ingest`: `USAGE` + `SELECT` on both `entries_entry_id_seq` sequences.
- `pgadmin`: `USAGE`/`SELECT`/`UPDATE` on both.

**Important nuance (idempotency_policies):**
- `pkm.idempotency_policies.policy_id` defaults to `nextval('..._policy_id_seq')`.
- As observed, `pkm_ingest` does **NOT** have explicit grants on `pkm.idempotency_policies_policy_id_seq` (same for `pkm_test`).
  - This is fine if the app never inserts into `idempotency_policies`.
  - If the app *does* insert without specifying `policy_id`, it will fail unless sequence grants are added.

### Default privileges

Observed default privileges (created by owner `pgadmin`):
- In schema `pkm`: future **tables** default grant `pkm_ingest=arwd` (SELECT/INSERT/UPDATE/DELETE).
- In schema `pkm_test`: future **tables** default grant `pkm_ingest=arwd`.
- In schema `public`: future **tables** default grant `pkm_ingest=aw` and `pkm_read=r`.

### Triggers and RLS

- No user-defined triggers in `pkm` or `pkm_test`.
- No Row Level Security (RLS) policies in `pkm` or `pkm_test`.

---

## Test vs prod + mirroring

### Core idea

Production and test are separated by schema:
- **Prod:** `pkm`
- **Test:** `pkm_test`

Most tables are mirrored in both schemas to allow safe experimentation.

### What is mirrored

Mirrored between `pkm` and `pkm_test`:
- `entries`
- `idempotency_policies`
- `t1_batches`
- `t1_batch_items`
- `t1_batch_item_results`

### What is NOT mirrored

- `pkm.runtime_config` exists **only in prod**.
  - It currently contains `is_test_mode = false` (jsonb boolean).

### Practical consequences for `/db/delete` and `/db/move`

- Because `pkm_ingest` **cannot DELETE from `pkm.entries`**, backend endpoints that delete/move **prod entries** must either:
  - use a DB role with DELETE on `pkm.entries`, or
  - use SECURITY DEFINER functions owned by `pgadmin` (preferred), or
  - adjust grants (not recommended without care).

- In test, `pkm_ingest` **can** delete (`pkm_test.entries` has RIUD).

---

## Tables

### `pkm.entries` / `pkm_test.entries`

**Purpose**
Primary storage for captured items (email, telegram, etc.) and Tier-1 enrichment outputs.

**Columns** (same structure in prod and test)

| Column | Type | Nullable | Default / Generated | Notes |
|---|---|---:|---|---|
| `id` | uuid | no | `gen_random_uuid()` | PK (stable across moves if you preserve it) |
| `created_at` | timestamptz | no | `now()` | ingestion time |
| `source` | text | no |  | e.g. `email`, `telegram` |
| `intent` | text | no | `'archive'` | |
| `capture_text` | text | no |  | raw-ish capture |
| `url` | text | yes |  | |
| `url_canonical` | text | yes |  | |
| `extracted_text` | text | yes |  | |
| `clean_text` | text | yes |  | |
| `content_hash` | text | yes |  | |
| `external_ref` | jsonb | yes |  | stable external ids / provenance |
| `metadata` | jsonb | yes |  | enrichment payloads |
| `tsv` | tsvector | yes | **generated stored** | weighted full-text vector from clean/extracted/capture text |
| `content_type` | text | yes |  | e.g. `newsletter`, `thought` |
| `title` | text | yes |  | |
| `author` | text | yes |  | |
| `topic_primary` | text | yes |  | Tier-1 classification |
| `topic_primary_confidence` | real | yes |  | |
| `topic_secondary` | text | yes |  | Tier-1 classification |
| `topic_secondary_confidence` | real | yes |  | |
| `keywords` | text[] | yes |  | Tier-1 |
| `enrichment_status` | text | yes | `'pending'` | pipeline state |
| `enrichment_model` | text | yes |  | pipeline info |
| `prompt_version` | text | yes |  | pipeline info |
| `gist` | text | yes |  | Tier-1 |
| `entry_id` | bigint | no | identity | human-facing id, UNIQUE per schema |
| `retrieval_excerpt` | text | yes |  | |
| `clean_word_count` | int | yes |  | quality signals |
| `clean_char_count` | int | yes |  | quality signals |
| `extracted_char_count` | int | yes |  | quality signals |
| `link_count` | int | yes |  | quality signals |
| `link_ratio` | real | yes |  | quality signals |
| `boilerplate_heavy` | bool | yes |  | quality signals |
| `low_signal` | bool | yes |  | quality signals |
| `quality_score` | real | yes |  | 0..1 |
| `idempotency_policy_key` | text | yes |  | FK to policy key |
| `idempotency_key_primary` | text | yes |  | durable dedupe key |
| `idempotency_key_secondary` | text | yes |  | fallback dedupe key |

**Constraints**
- PK: `(id)`
- Unique: `(entry_id)`
- FK: `idempotency_policy_key` → `idempotency_policies(policy_key)` with `ON DELETE SET NULL`

**Indexes (prod)**
- PK: `entries_pkey` on `(id)`
- `entries_entry_id_uidx` UNIQUE on `(entry_id)`
- `entries_created_at_idx` on `(created_at DESC)`
- `entries_source_created_at_idx` on `(source, created_at DESC)`
- `entries_intent_created_at_idx` on `(intent, created_at DESC)`
- `entries_content_type_created_at_idx` on `(content_type, created_at DESC)`
- `entries_topic_primary_created_at_idx` on `(topic_primary, created_at DESC)`
- `entries_topic_secondary_created_at_idx` on `(topic_secondary, created_at DESC)`
- `entries_content_hash_idx` on `(content_hash)`
- `entries_tsv_gin_idx` GIN on `(tsv)`
- `entries_keywords_gin_idx` GIN on `(keywords)`
- `entries_quality_good_created_at_idx` partial on `(created_at DESC)` WHERE `boilerplate_heavy IS NOT TRUE AND low_signal IS NOT TRUE`
- `pkm_entries_idem_primary_uidx` UNIQUE partial on `(idempotency_policy_key, idempotency_key_primary)`
- `pkm_entries_idem_secondary_uidx` UNIQUE partial on `(idempotency_policy_key, idempotency_key_secondary)`

**Indexes (test)**
Same intent as prod, but names differ slightly:
- Unique `(entry_id)` index is `entries_entry_id_idx`
- Partial “quality good” index is `entries_created_at_idx1`
- Full-text index name is `entries_tsv_idx`
- Keywords GIN index name is `entries_keywords_idx`

---

### `pkm.idempotency_policies` / `pkm_test.idempotency_policies`

**Purpose**
Defines idempotency/deduplication behavior per `(source, content_type)` and stable `policy_key`.

**Columns**
- `policy_id` bigint PK (default `nextval(...)`)
- `policy_key` text UNIQUE
- `source` text
- `content_type` text
- `conflict_action` text CHECK in `{skip, update}`
- `update_fields` text[] (optional)
- `enabled` boolean default true
- `notes` text (optional)
- `created_at` timestamptz default now()
- `updated_at` timestamptz default now()

**Constraints / indexes**
- PK `(policy_id)`
- Unique `(policy_key)`
- Check: `conflict_action IN ('skip','update')`

**Seed policies (current)**
- `telegram_thought_v1` (telegram / thought / update)
- `telegram_link_v1` (telegram / link / skip)
- `email_newsletter_v1` (email / newsletter / skip)
- `email_correspondence_message_v1` (email / correspondence_message / skip)
- `email_correspondence_thread_v1` (email / correspondence_thread / update)
- `email_backfill_newsletter_v1` (email / newsletter / skip)

---

### `pkm.runtime_config`

**Purpose**
Small shared key/value store for runtime toggles used by backend and workflows.

**Columns**
- `key` text PK
- `value` jsonb NOT NULL
- `updated_at` timestamptz default now()

**Current keys**
- `is_test_mode`: `false`

**Access**
- `pkm_ingest`: RIUD
- `pkm_read`: R
- `n8n`: R

---

### Tier-1 Batch Persistence

These tables support restart-safe OpenAI batch processing.

#### `pkm.t1_batches` / `pkm_test.t1_batches`

- `batch_id` text PK
- `status` text
- `model` text
- `input_file_id` text
- `output_file_id` text
- `error_file_id` text
- `request_count` int
- `metadata` jsonb
- `created_at` timestamptz default now()

Indexes:
- PK `(batch_id)`
- `(status, created_at)` (`idx_pkm_*_t1_batches_status_created_at`)

#### `pkm.t1_batch_items` / `pkm_test.t1_batch_items`

- `batch_id` text
- `custom_id` text
- `title` text
- `author` text
- `content_type` text
- `prompt_mode` text
- `prompt` text
- `created_at` timestamptz default now()

Indexes:
- PK `(batch_id, custom_id)`
- `(batch_id)`

#### `pkm.t1_batch_item_results` / `pkm_test.t1_batch_item_results`

- `batch_id` text
- `custom_id` text
- `status` text NOT NULL
- `response_text` text
- `parsed` jsonb
- `error` jsonb
- `raw` jsonb
- `updated_at` timestamptz default now()
- `created_at` timestamptz default now()

Indexes:
- PK `(batch_id, custom_id)`
- `(batch_id, status)`
- `(updated_at)`

---


## Backups

This project uses **logical Postgres backups** (`pg_dump` custom format) because the DB is still small and we want **fast, low-risk** operations with easy restore.

### Policy and frequency

**Local backups (cron on host)**
- **Daily**: 02:10 local time — creates fresh dumps for `pkm` and `n8n` and builds the rolling “daily” bundle.
- **Weekly**: Sunday 02:20 — promotes the most recent nightly dumps and builds the rolling “weekly” bundle.
- **Monthly**: 1st of month 02:25 — promotes the most recent nightly dumps and builds the rolling “monthly” bundle.
- **Rotation**: 02:35 — prunes old local history.

**Retention (local disk)**
- Nightly: keep **14 days**
- Weekly: keep **8 weeks**
- Monthly: keep **12 months**

Notes:
- Backups are **logical only** (no WAL archiving).
- Backups run outside peak hours to reduce chances of ingestion/maintenance operations failing.

### On-disk locations

Backups live on the host under:

- Root: `/home/igasovic/backup/postgres`
- Timestamped history:
  - `nightly/` — fresh daily dumps
  - `weekly/` — weekly promoted copies
  - `monthly/` — monthly promoted copies
- Rolling bundles for off-site upload (overwritten each run):
  - `/home/igasovic/backup/postgres/uploads/pkm_backup_daily.tgz`
  - `/home/igasovic/backup/postgres/uploads/pkm_backup_weekly.tgz`
  - `/home/igasovic/backup/postgres/uploads/pkm_backup_monthly.tgz`

Each bundle contains:
- `pkm.dump` (custom-format `pg_dump`)
- `n8n.dump`
- `globals.sql.gz` (roles/grants; optional to apply during restore)
- `SHA256SUMS` (integrity)
- `MANIFEST.txt` (metadata)

Scripts are versioned in the repo:
- `/home/igasovic/repos/n8n-workflows/scripts/db/backup.sh`
- `/home/igasovic/repos/n8n-workflows/scripts/db/rotate.sh`
- `/home/igasovic/repos/n8n-workflows/scripts/db/restore.sh`

### Off-site backup (n8n → Google Drive)

Off-site copies are pushed by n8n to Google Drive and intentionally kept to **only 3 files** (latest daily/weekly/monthly).

**How it works**
- n8n reads the rolling bundle files from disk (mounted into the n8n container under the allowed path):
  - `/home/node/.n8n-files/backup-postgres/uploads/pkm_backup_daily.tgz`
  - `/home/node/.n8n-files/backup-postgres/uploads/pkm_backup_weekly.tgz`
  - `/home/node/.n8n-files/backup-postgres/uploads/pkm_backup_monthly.tgz`
- Workflow schedule: **04:00** daily
  - Always uploads **daily**
  - Uploads **weekly** only on Sunday
  - Uploads **monthly** only on the 1st
- Overwrite policy: if a file with the same name exists in the target folder, n8n deletes it and uploads the new one (ensures exactly 3 files).

### Monitoring and alerting

- Cron jobs report status to n8n via local webhooks.
- On failure, n8n sends a Telegram alert.
- A daily **09:00** Telegram summary reports the latest status for: daily/weekly/monthly/rotation.

### Restore

- Preferred: restore into **scratch DBs** first (safe), then promote to prod only if needed.
- `restore.sh` supports:
  - `--target scratch` (default): restores into `pkm_restore_YYYYmmdd_HHMMSS` and `n8n_restore_YYYYmmdd_HHMMSS`
  - `--target prod`: requires `CONFIRM_PROD=YES` to prevent accidents
- Integrity: bundles include `SHA256SUMS`; restore verifies checksums when present.


## What else is useful (recommended additions)

If you want this schema doc to be maximally helpful for agents, consider adding:

1. **Operational invariants**
   - which columns are considered canonical vs derived
   - how “idempotency keys” are constructed (where they live in metadata/external_ref)

2. **Admin operations contract**
   - the exact semantics for `/db/delete` and `/db/move` (what is preserved, what is re-assigned)
   - validation rules (max ranges, dry-run requirement, explicit schema requirement)

3. **Data lifecycle**
   - when to truncate `pkm_test.*`
   - whether `pkm` ever gets truncated (ideally never)

4. **Perf expectations**
   - common query patterns and which indexes support them
   - when to VACUUM/ANALYZE (if you see bloat)

